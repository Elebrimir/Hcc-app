rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Funciones de Ayuda (Helpers) ---

    // Función para verificar si el usuario autenticado es el dueño del documento
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isUpdatingAllowedProfileFields() {
      let allowedFields = ['name', 'lastname', 'image'];
      let updatedKeys = request.resource.data.diff(resource.data).affectedKeys();
      return updatedKeys.hasOnly(allowedFields);
    }

    function areProfileFieldsValid() {
      let newData = request.resource.data;
      let oldData = resource.data;
      let incomingKeys = newData.keys();

      let nameValid = !incomingKeys.hasAny(['name']) || (newData.name is string && newData.name.size() > 0 && newData.name.size() < 100);
      let lastnameValid = !incomingKeys.hasAny(['lastname']) || (newData.lastname is string && newData.lastname.size() < 100);
      let imageValid = !incomingKeys.hasAny(['image']) || ((newData.image is string && newData.image.size() < 500) || newData.image == null);

      let emailUnchanged = newData.email == oldData.email;
      let roleUnchanged = newData.role == oldData.role;
      let createdAtUnchanged = newData.created_at == oldData.get('created_at', null);

      return nameValid && lastnameValid && imageValid && emailUnchanged && roleUnchanged && createdAtUnchanged;
    }

    match /users/{userId} {
      allow read: if isOwner(userId);
      allow list: if request.auth != null;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && isUpdatingAllowedProfileFields() && areProfileFieldsValid();
      allow delete: if false;
    } // Fin /users/{userId}

    match /teams/{teamId} {

      allow get: if request.auth != null;
      allow list: if request.auth != null;
      allow create: if false; // TODO: AJUSTAR SEGÚN TUS NECESIDADES
      allow update: if false; // TODO: AJUSTAR SEGÚN TUS NECESIDADES
      allow delete: if false; // TODO: AJUSTAR SEGÚN TUS NECESIDADES

    } // Fin /teams/{teamId}

    match /events/{eventId} {

      allow get, list: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.creatorUid == request.auth.uid;
      allow update: if request.auth != null && request.auth.uid == resource.data.creatorUid;
      allow delete: if request.auth != null && request.auth.uid == resource.data.creatorUid;
    }

    match /convocatorias/{convocatoriaId} {
      allow read, write: if request.auth != null;
    }

    match /products/{productId} {

      allow get, list: if request.auth != null;
      allow create: if false; // TODO: AJUSTAR SEGÚN TUS NECESIDADES
      allow update: if false; // TODO: AJUSTAR SEGÚN TUS NECESIDADES
      allow delete: if false; // TODO: AJUSTAR SEGÚN TUS NECESIDADES

    }
  } // Fin /databases/{database}/documents
} // Fin service cloud.firestore
