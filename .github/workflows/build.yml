name: Build App Workflow
permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  push:
    branches:
      - main
    paths:
      - "android/**"
      - "lib/**"
  workflow_dispatch:
    inputs:
      build:
        description: "Tipo de build (android)"
        required: true
        default: "android"
        type: choice
        options:
          - android

jobs:
  # Job para construir la aplicaci칩n Android
  build_android_app:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.build == 'android'
    steps:
      - uses: actions/checkout@v5

      - uses: dart-lang/setup-dart@9a04e6d73cca37bd455e0608d7e5092f881fd603

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.x"
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build the app (Android)
        run: flutter build apk --split-per-abi

      - name: Analyze APK size
        run: |
          mkdir -p apk_analysis
          echo "# APK Size Analysis" > apk_analysis/report.md
          echo "## Build date: $(date)" >> apk_analysis/report.md
          echo "## Commit: ${{ github.sha }}" >> apk_analysis/report.md
          echo "" >> apk_analysis/report.md
          echo "| APK | Size |" >> apk_analysis/report.md
          echo "|-----|------|" >> apk_analysis/report.md

          # Analizar cada APK generado
          for apk in build/app/outputs/flutter-apk/*.apk; do
            name=$(basename $apk)
            size=$(du -h $apk | cut -f1)
            size_bytes=$(du -b $apk | cut -f1)
            echo "| $name | $size ($size_bytes bytes) |" >> apk_analysis/report.md

            # Opcional: guardar el tama침o en un archivo para comparaciones hist칩ricas
            echo "$size_bytes" > "apk_analysis/${name}.size"
          done

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v5
        with:
          name: android-release
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 7

      - name: Upload APK size analysis
        uses: actions/upload-artifact@v5
        with:
          name: apk-size-analysis
          path: apk_analysis
          retention-days: 30

  notify_build_results:
    runs-on: ubuntu-latest
    needs: [build_android_app]
    if: always() && (needs.build_android_app.result == 'success')
    steps:
      - name: Download Android analysis
        uses: actions/download-artifact@v6
        with:
          name: apk-size-analysis
          path: size_analysis/android
        if: needs.build_android_app.result == 'success'
        continue-on-error: true

      - name: Generate summary
        id: summary
        run: |
          echo "### 游늵 An치lisis de tama침o de build" > summary.md
          echo "" >> summary.md

          # A침adir an치lisis de Android si existe
          if [ -f "size_analysis/android/report.md" ]; then
            echo "<details><summary>游님 An치lisis APK</summary>" >> summary.md
            echo "" >> summary.md
            cat size_analysis/android/report.md >> summary.md
            echo "" >> summary.md
            echo "</details>" >> summary.md
            echo "" >> summary.md
          fi

          # Guardar resumen como output para usar en los pasos siguientes
          MESSAGE=$(cat summary.md)
          MESSAGE="${MESSAGE//'%'/'%25'}"
          MESSAGE="${MESSAGE//$'\n'/'%0A'}"
          MESSAGE="${MESSAGE//$'\r'/'%0D'}"
          echo "content=$MESSAGE" >> $GITHUB_OUTPUT
