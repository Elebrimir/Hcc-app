name: Version Bump

on:
  push:
    branches:
      - main
    paths:
      - "lib/**"
      - "test/**"
      - "widgets/**"
  workflow_dispatch:
    inputs:
      bump:
        description: "Tipo de incremento (patch, minor, major)"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  bump-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for existing version bump PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OPEN_PRS=$(gh pr list --label "version-bump" --state open --json number --jq length)
          if [ "$OPEN_PRS" -gt 0 ]; then
            echo "‚ö†Ô∏è Ya existe un PR de version bump abierto. Cancelando workflow."
            exit 1
          fi
          echo "‚úì No hay PRs de version bump abiertos"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Determine bump type
        id: bump-type
        run: |
          # Obtener √∫ltimo TAG con fallback
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            echo "‚ö†Ô∏è No se encontr√≥ ning√∫n tag. Asumiendo primera release."
            LATEST_TAG=$(git rev-list --max-parents=0 HEAD)
          fi

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BUMP_TYPE="${{ github.event.inputs.bump }}"
          else
            # L√≥gica autom√°tica simplificada para el ejemplo
            CHANGED_FILES=$(git diff --name-only --diff-filter=AM $LATEST_TAG..HEAD | grep -E '^(lib|test|widgets)/' || echo "")
            NEW_FILES=$(echo "$CHANGED_FILES" | wc -l)

            # Tu l√≥gica original de detecci√≥n...
            if [ "$NEW_FILES" -gt 10 ]; then BUMP_TYPE="minor"; else BUMP_TYPE="patch"; fi
            echo "type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          fi

          # Obtener mensajes de commits
          COMMIT_MSGS=$(git log $LATEST_TAG..HEAD --pretty=format:'* %s' --reverse | grep -v '^\s*$' || echo "* Initial release")

          # Fix para multiline strings en GITHUB_OUTPUT
          {
            echo "commit_message<<EOF"
            echo "$COMMIT_MSGS"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          # Fix para multiline strings en GITHUB_STEP_SUMMARY
          echo "### üìä An√°lisis de Cambios" >> $GITHUB_STEP_SUMMARY
          echo "- Bump: $BUMP_TYPE" >> $GITHUB_STEP_SUMMARY

      - name: Read current version
        id: current-version
        run: |
          VERSION=$(grep -E '^version: ' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          BUILD=$(grep -E '^version: ' pubspec.yaml | awk '{print $2}' | cut -d'+' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build=$BUILD" >> $GITHUB_OUTPUT

      - name: Bump version
        id: bump-version
        run: |
          BUMP_TYPE="${{ steps.bump-type.outputs.type }}"
          CURRENT_VERSION="${{ steps.current-version.outputs.version }}"
          CURRENT_BUILD="${{ steps.current-version.outputs.build }}"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          if [ "$BUMP_TYPE" == "major" ]; then
            MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0
          elif [ "$BUMP_TYPE" == "minor" ]; then
            MINOR=$((MINOR+1)); PATCH=0
          else
            PATCH=$((PATCH+1))
          fi

          NEW_BUILD=$((CURRENT_BUILD+1))
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_build=$NEW_BUILD" >> $GITHUB_OUTPUT

      - name: Update pubspec.yaml
        run: |
          sed -i "s/^version: .*/version: ${{ steps.bump-version.outputs.new_version }}+${{ steps.bump-version.outputs.new_build }}/" pubspec.yaml

      - name: Update CHANGELOG.md
        env:
          COMMIT_MSG_ENV: ${{ steps.bump-type.outputs.commit_message }}
        run: |
          DATE=$(date +%Y-%m-%d)
          COMMIT_MSG=$(printf '%b' "$COMMIT_MSG_ENV")
          HEADER_LINE="## [${{ steps.bump-version.outputs.new_version }}] - ${DATE}"

          # Tu l√≥gica de awk se mantiene igual
          awk -v header="$HEADER_LINE" -v msg="$COMMIT_MSG" 'BEGIN { inserted=0 } /## \[No publicado\]/ && !inserted { print $0; print ""; print header; print ""; print msg; inserted=1; next } { print $0 }' CHANGELOG.md > CHANGELOG.md.new && mv CHANGELOG.md.new CHANGELOG.md

      - name: Get Dependencies
        run: flutter pub get

      - name: Apply Dart Formatting
        run: |
          dart format .
          dart fix --apply

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit
        id: pre-commit-run
        run: |
          # Ejecutamos pre-commit. Si falla (porque modific√≥ archivos), no pasa nada,
          # porque el siguiente paso har√° git add de esos cambios.
          pre-commit run --all-files || true

      - name: Create Pull Request for Version Bump
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BODY_ENV: ${{ steps.bump-type.outputs.commit_message }}
        run: |
          NEW_VERSION_FULL="${{ steps.bump-version.outputs.new_version }}+${{ steps.bump-version.outputs.new_build }}"
          BRANCH_NAME="bump/version-${NEW_VERSION_FULL}"
          COMMIT_MSG="chore: bump version to ${NEW_VERSION_FULL}"
          PR_TITLE="üîñ Bump version to ${NEW_VERSION_FULL}"

          # Construcci√≥n del body (simplificado para el ejemplo)
          PR_BODY="Automated Version Bump to ${NEW_VERSION_FULL}"

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git checkout -b ${BRANCH_NAME}

          # üî¥ IMPORTANTE: Esto a√±ade los cambios de versi√≥n Y los cambios de formato/pre-commit
          git add .

          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è No hay cambios para commitear"
            exit 1
          fi

          git commit -m "${COMMIT_MSG}"
          git push --set-upstream origin ${BRANCH_NAME} --force

          # Creaci√≥n de labels y PR...
          gh label create "version-bump" --color "0E8A16" --force || true
          gh label create "automated" --color "ededed" --force || true

          gh pr create \
            --base main \
            --head ${BRANCH_NAME} \
            --title "${PR_TITLE}" \
            --body "${PR_BODY}" \
            --label "version-bump" \
            --label "automated"
