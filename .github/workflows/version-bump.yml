name: Version Bump

on:
  push:
    branches:
      - main
    paths:
      - "lib/**"
      - "test/**"
      - "widgets/**"
  workflow_dispatch:
    inputs:
      bump:
        description: "Tipo de incremento (patch, minor, major)"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  bump-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for existing version bump PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OPEN_PRS=$(gh pr list --label "version-bump" --state open --json number --jq length)
          if [ "$OPEN_PRS" -gt 0 ]; then
            echo "âš ï¸ Ya existe un PR de version bump abierto. Cancelando workflow."
            exit 1
          fi
          echo "âœ“ No hay PRs de version bump abiertos"

      - name: Set up Dart
        uses: dart-lang/setup-dart@v1

      - name: Determine bump type
        id: bump-type
        run: |
          # Obtener Ãºltimo TAG con fallback para primera release
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            echo "âš ï¸ No se encontrÃ³ ningÃºn tag. Asumiendo primera release."
            LATEST_TAG=$(git rev-list --max-parents=0 HEAD)
            echo "Usando commit inicial: $LATEST_TAG"
          else
            echo "âœ“ Ãšltimo tag detectado: $LATEST_TAG"
          fi

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BUMP_TYPE="${{ github.event.inputs.bump }}"
            echo "type=$BUMP_TYPE" >> $GITHUB_OUTPUT
            echo "ðŸ“ Usando tipo de bump especificado manualmente: $BUMP_TYPE"
          else
            # Obtener archivos cambiados y nuevos
            CHANGED_FILES=$(git diff --name-only --diff-filter=AM $LATEST_TAG..HEAD | grep -E '^(lib|test|widgets)/' || echo "")
            NEW_FILES=$(git diff --name-only --diff-filter=A $LATEST_TAG..HEAD | grep -E '^(lib|test|widgets)/' || echo "")

            # Contar archivos nuevos en categorÃ­as especÃ­ficas
            NEW_MODELS_PAGES_WIDGETS=$(echo "$NEW_FILES" | grep -E 'lib/(models|pages|widgets)/' | wc -l)
            TOTAL_NEW_FILES=$(echo "$NEW_FILES" | wc -l)

            # Determinar tipo de bump basado en cambios
            if [ "$TOTAL_NEW_FILES" -gt 1 ]; then
              BUMP_TYPE="major"
              echo "ðŸš€ MAJOR bump: $TOTAL_NEW_FILES archivos nuevos detectados"
            elif [ "$NEW_MODELS_PAGES_WIDGETS" -ge 1 ]; then
              BUMP_TYPE="minor"
              echo "âœ¨ MINOR bump: $NEW_MODELS_PAGES_WIDGETS archivo(s) nuevo(s) en models/pages/widgets"
            else
              BUMP_TYPE="patch"
              echo "ðŸ”§ PATCH bump: Solo modificaciones o tests aÃ±adidos"
            fi

            echo "type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          fi

          # Obtener mensajes de commits desde el Ãºltimo tag
          COMMIT_MSGS=$(git log $LATEST_TAG..HEAD --pretty=format:'* %s' --reverse | grep -v '^\s*$' || echo "* Initial release")
          echo "commit_message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Crear resumen para GitHub Actions
          echo "### ðŸ“Š AnÃ¡lisis de Cambios" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tipo de bump:** \`$BUMP_TYPE\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Archivos nuevos:** $TOTAL_NEW_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- **Desde tag:** \`$LATEST_TAG\`" >> $GITHUB_STEP_SUMMARY

      - name: Read current version
        id: current-version
        run: |
          VERSION=$(grep -E '^version: ' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          BUILD=$(grep -E '^version: ' pubspec.yaml | awk '{print $2}' | cut -d'+' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build=$BUILD" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION+$BUILD"

      - name: Bump version
        id: bump-version
        run: |
          BUMP_TYPE="${{ steps.bump-type.outputs.type }}"
          CURRENT_VERSION="${{ steps.current-version.outputs.version }}"
          CURRENT_BUILD="${{ steps.current-version.outputs.build }}"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # Incrementar segÃºn tipo
          if [ "$BUMP_TYPE" == "major" ]; then
            MAJOR=$((MAJOR+1))
            MINOR=0
            PATCH=0
          elif [ "$BUMP_TYPE" == "minor" ]; then
            MINOR=$((MINOR+1))
            PATCH=0
          else
            PATCH=$((PATCH+1))
          fi

          # Incrementar build number
          NEW_BUILD=$((CURRENT_BUILD+1))

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_build=$NEW_BUILD" >> $GITHUB_OUTPUT
          echo "âœ“ Nueva versiÃ³n: $NEW_VERSION+$NEW_BUILD"

          # AÃ±adir al resumen
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Nueva VersiÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Anterior:** \`$CURRENT_VERSION+$CURRENT_BUILD\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Nueva:** \`$NEW_VERSION+$NEW_BUILD\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tipo:** \`$BUMP_TYPE\`" >> $GITHUB_STEP_SUMMARY

      - name: Update pubspec.yaml
        run: |
          sed -i "s/^version: .*/version: ${{ steps.bump-version.outputs.new_version }}+${{ steps.bump-version.outputs.new_build }}/" pubspec.yaml
          cat pubspec.yaml | grep version

      - name: Update CHANGELOG.md
        env:
          COMMIT_MSG_ENV: ${{ steps.bump-type.outputs.commit_message }}
        run: |
          DATE=$(date +%Y-%m-%d)
          COMMIT_MSG=$(printf '%b' "$COMMIT_MSG_ENV")
          HEADER_LINE="## [${{ steps.bump-version.outputs.new_version }}] - ${DATE}"

          # Insertar nueva entrada despuÃ©s de "## [No publicado]"
          awk -v header="$HEADER_LINE" -v msg="$COMMIT_MSG" '
          BEGIN { inserted=0 }
          /## \[No publicado\]/ && !inserted {
            print $0
            print ""
            print header
            print ""
            print msg
            inserted=1
            next
          }
          { print $0 }
          ' CHANGELOG.md > CHANGELOG.md.new && mv CHANGELOG.md.new CHANGELOG.md

          echo "âœ“ CHANGELOG.md actualizado"

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit
        id: pre-commit-run
        continue-on-error: true
        run: |
          pre-commit run --all-files || true
          if [[ -n $(git status -s) ]]; then
            echo "âœ“ Pre-commit realizÃ³ cambios automÃ¡ticos"
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "âœ“ Pre-commit no encontrÃ³ cambios necesarios"
            echo "changed=false" >> $GITHUB_OUTPUT
          fi


      - name: Create Pull Request for Version Bump
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BODY_ENV: ${{ steps.bump-type.outputs.commit_message }}
        run: |
          NEW_VERSION_FULL="${{ steps.bump-version.outputs.new_version }}+${{ steps.bump-version.outputs.new_build }}"
          BRANCH_NAME="bump/version-${NEW_VERSION_FULL}"
          COMMIT_MSG="chore: bump version to ${NEW_VERSION_FULL}"
          PR_TITLE="ðŸ”– Bump version to ${NEW_VERSION_FULL}"

          # Formatear el cuerpo de la PR
          PR_BODY=$(cat <<EOF
          ## ðŸ“¦ Version Bump

          **Tipo:** \`${{ steps.bump-type.outputs.type }}\`
          **VersiÃ³n anterior:** \`${{ steps.current-version.outputs.version }}+${{ steps.current-version.outputs.build }}\`
          **Nueva versiÃ³n:** \`${NEW_VERSION_FULL}\`

          ### ðŸ“ Cambios incluidos

          $(printf '%b' "$PR_BODY_ENV")

          ---
          *Este PR fue generado automÃ¡ticamente por el workflow de version bump.*
          EOF
          )

          echo "ðŸ“ Configurando Git..."
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          echo "ðŸŒ¿ Creando rama: ${BRANCH_NAME}"
          git checkout -b ${BRANCH_NAME}

          echo "ðŸ“¦ AÃ±adiendo cambios..."
          git add .

          if git diff --staged --quiet; then
            echo "âš ï¸ No hay cambios para commitear"
            exit 1
          fi

          git commit -m "${COMMIT_MSG}"

          echo "â¬†ï¸ Subiendo rama..."
          git push --set-upstream origin ${BRANCH_NAME}

          echo "ðŸ”€ Creando Pull Request..."
          gh pr create \
            --base main \
            --head ${BRANCH_NAME} \
            --title "${PR_TITLE}" \
            --body "${PR_BODY}" \
            --label "version-bump" \
            --label "automated"

          echo "âœ… Pull Request creada exitosamente"
